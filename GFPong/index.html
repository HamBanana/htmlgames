<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong - Karate Guy vs Ninja Man</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            font-family: 'Courier New', monospace;
            color: #ffffff;
            overflow: hidden;
        }
        
        #gameContainer {
            position: relative;
            border: 3px solid #4a5568;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(74, 85, 104, 0.5);
            background: #000;
        }
        
        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }
        
        .loading h1 {
            color: #4fd1c7;
            text-shadow: 0 0 10px rgba(79, 209, 199, 0.5);
            margin-bottom: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #2d3748;
            border-top: 4px solid #4fd1c7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .controls {
            position: absolute;
            bottom: -80px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: 12px;
            color: #a0aec0;
        }
        
        .controls div {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div class="loading" id="loading">
            <h1>🥋 PONG 🥷</h1>
            <div>Karate Guy vs Ninja Man</div>
            <div class="spinner"></div>
            <div style="margin-top: 20px; font-size: 12px;">Loading GameFramework...</div>
        </div>
        
        <canvas id="gameCanvas" style="display: none;"></canvas>
        
        <div class="controls">
            <div><strong>Controls:</strong></div>
            <div>Player 1 (Karate Guy): W/S keys</div>
            <div>Player 2 (Ninja Man): ↑/↓ arrow keys</div>
            <div>Press SPACE to start/reset</div>
        </div>
    </div>

    <script src="/GameFramework/index.js"></script>
    <script>
        // Game state
        let game;
        let player1, player2, ball;
        let score = { player1: 0, player2: 0 };
        let gameStarted = false;
        let ballSpeed = { x: 300, y: 200 };

        // Define custom components before framework loading
        function defineComponents() {
            // Paddle Component
            window.PaddleComponent = class extends Component {
                constructor(config = {}) {
                    super(config);
                    this.player = config.player || 1;
                    this.speed = config.speed || 300;
                    this.color = config.color || '#ffffff';
                    this.name = config.name || `Player ${this.player}`;
                }

                update(deltaTime) {
                    if (!gameStarted) return;

                    const input = this.game.getSystem('input');
                    if (!input) return;

                    let movement = 0;

                    // Player 1 controls (W/S)
                    if (this.player === 1) {
                        if (input.isActionPressed('p1up')) movement = -1;
                        if (input.isActionPressed('p1down')) movement = 1;
                    }
                    // Player 2 controls (Arrow keys)
                    else if (this.player === 2) {
                        if (input.isActionPressed('p2up')) movement = -1;
                        if (input.isActionPressed('p2down')) movement = 1;
                    }

                    // Apply movement
                    this.entity.y += movement * this.speed * deltaTime;

                    // Keep paddle within screen bounds
                    this.entity.y = Math.max(0, Math.min(this.game.canvas.height - this.entity.height, this.entity.y));
                }

                render(context) {
                    // Draw paddle
                    context.fillStyle = this.color;
                    context.fillRect(0, 0, this.entity.width, this.entity.height);

                    // Add glow effect
                    context.shadowColor = this.color;
                    context.shadowBlur = 10;
                    context.fillRect(0, 0, this.entity.width, this.entity.height);
                    context.shadowBlur = 0;

                    // Draw player icon
                    context.fillStyle = '#ffffff';
                    context.font = '16px Arial';
                    context.textAlign = 'center';
                    context.fillText(
                        this.player === 1 ? '🥋' : '🥷',
                        this.entity.width / 2,
                        this.entity.height / 2 + 6
                    );
                }
            };

            // Ball Component
            window.BallComponent = class extends Component {
                constructor(config = {}) {
                    super(config);
                    this.baseSpeed = config.speed || { x: 300, y: 200 };
                    this.velocity = { x: 0, y: 0 };
                    this.color = config.color || '#ffffff';
                    this.trail = [];
                    this.maxTrailLength = 8;
                    this.reset();
                }

                reset() {
                    // Random direction
                    const direction = Math.random() < 0.5 ? -1 : 1;
                    this.velocity.x = this.baseSpeed.x * direction;
                    this.velocity.y = (Math.random() - 0.5) * this.baseSpeed.y * 2;
                    this.trail = [];
                }

                update(deltaTime) {
                    if (!gameStarted) {
                        // Pulse effect when waiting
                        this.pulseTime = (this.pulseTime || 0) + deltaTime * 3;
                        return;
                    }

                    // Store trail positions
                    this.trail.push({ x: this.entity.x, y: this.entity.y });
                    if (this.trail.length > this.maxTrailLength) {
                        this.trail.shift();
                    }

                    // Move ball
                    this.entity.x += this.velocity.x * deltaTime;
                    this.entity.y += this.velocity.y * deltaTime;

                    // Bounce off top and bottom walls
                    if (this.entity.y <= 0 || this.entity.y >= this.game.canvas.height - this.entity.height) {
                        this.velocity.y = -this.velocity.y;
                        this.entity.y = Math.max(0, Math.min(this.game.canvas.height - this.entity.height, this.entity.y));
                    }

                    // Check paddle collisions
                    this.checkPaddleCollisions();

                    // Check scoring
                    this.checkScoring();
                }

                checkPaddleCollisions() {
                    // Check collision with player 1 (left paddle)
                    if (this.velocity.x < 0 && 
                        this.entity.x <= player1.x + player1.width &&
                        this.entity.x + this.entity.width >= player1.x &&
                        this.entity.y <= player1.y + player1.height &&
                        this.entity.y + this.entity.height >= player1.y) {
                        
                        this.handlePaddleHit(player1, 1);
                    }

                    // Check collision with player 2 (right paddle)
                    if (this.velocity.x > 0 && 
                        this.entity.x + this.entity.width >= player2.x &&
                        this.entity.x <= player2.x + player2.width &&
                        this.entity.y <= player2.y + player2.height &&
                        this.entity.y + this.entity.height >= player2.y) {
                        
                        this.handlePaddleHit(player2, 2);
                    }
                }

                handlePaddleHit(paddle, playerNum) {
                    // Reverse X direction
                    this.velocity.x = -this.velocity.x;

                    // Add spin based on where ball hits paddle
                    const paddleCenter = paddle.y + paddle.height / 2;
                    const ballCenter = this.entity.y + this.entity.height / 2;
                    const hitPosition = (ballCenter - paddleCenter) / (paddle.height / 2);
                    
                    // Modify Y velocity based on hit position
                    this.velocity.y = hitPosition * this.baseSpeed.y;

                    // Increase speed slightly
                    this.velocity.x *= 1.05;
                    this.velocity.y *= 1.05;

                    // Keep ball outside paddle
                    if (playerNum === 1) {
                        this.entity.x = paddle.x + paddle.width;
                    } else {
                        this.entity.x = paddle.x - this.entity.width;
                    }

                    // Visual effect
                    this.game.createParticleEffect('hit', this.entity.x, this.entity.y);
                }

                checkScoring() {
                    // Player 2 scores (ball went off left side)
                    if (this.entity.x < -this.entity.width) {
                        this.game.events.emit('ball:score', { player: 2 });
                    }
                    // Player 1 scores (ball went off right side)
                    else if (this.entity.x > this.game.canvas.width) {
                        this.game.events.emit('ball:score', { player: 1 });
                    }
                }

                render(context) {
                    // Draw trail
                    this.trail.forEach((pos, index) => {
                        const alpha = (index + 1) / this.trail.length * 0.3;
                        context.save();
                        context.globalAlpha = alpha;
                        context.fillStyle = this.color;
                        context.fillRect(pos.x, pos.y, this.entity.width, this.entity.height);
                        context.restore();
                    });

                    // Draw ball
                    if (!gameStarted) {
                        // Pulsing effect
                        const pulse = Math.sin(this.pulseTime || 0) * 0.3 + 0.7;
                        context.save();
                        context.globalAlpha = pulse;
                    }

                    context.fillStyle = this.color;
                    context.shadowColor = this.color;
                    context.shadowBlur = 15;
                    context.fillRect(0, 0, this.entity.width, this.entity.height);
                    context.shadowBlur = 0;

                    if (!gameStarted) {
                        context.restore();
                        
                        // Draw "SPACE to start" text
                        context.fillStyle = '#888888';
                        context.font = '16px Arial';
                        context.textAlign = 'center';
                        context.fillText('SPACE to start', 0, -30);
                    }
                }
            };

            // Score Display Component
            window.ScoreDisplayComponent = class extends Component {
                render(context) {
                    // Draw score
                    context.fillStyle = '#ffffff';
                    context.font = 'bold 36px Arial';
                    context.textAlign = 'center';
                    
                    // Player 1 score
                    context.fillText(score.player1.toString(), this.game.canvas.width / 4, 50);
                    
                    // Player 2 score
                    context.fillText(score.player2.toString(), (this.game.canvas.width * 3) / 4, 50);

                    // Player names
                    context.font = '14px Arial';
                    context.fillStyle = '#ff6b6b';
                    context.fillText('🥋 Karate Guy', this.game.canvas.width / 4, 70);
                    
                    context.fillStyle = '#4ecdc4';
                    context.fillText('🥷 Ninja Man', (this.game.canvas.width * 3) / 4, 70);

                    // Instructions
                    if (!gameStarted) {
                        context.fillStyle = '#888888';
                        context.font = '18px Arial';
                        context.fillText('Press SPACE to start', this.game.canvas.width / 2, this.game.canvas.height / 2 + 80);
                        
                        if (score.player1 > 0 || score.player2 > 0) {
                            context.font = '14px Arial';
                            context.fillText('Press R to reset score', this.game.canvas.width / 2, this.game.canvas.height / 2 + 105);
                        }
                    }
                }
            };

            // Center Line Component
            window.CenterLineComponent = class extends Component {
                render(context) {
                    context.fillStyle = '#333333';
                    context.fillRect(0, 0, this.entity.width, this.entity.height);
                    
                    // Dashed line effect
                    context.fillStyle = '#666666';
                    for (let y = 0; y < this.entity.height; y += 20) {
                        context.fillRect(0, y, this.entity.width, 10);
                    }
                }
            };
        }

        // Wait for framework to load
        window.addEventListener('gameframework:ready', async () => {
            try {
                // Define components first
                defineComponents();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('gameCanvas').style.display = 'block';
                
                console.log('🎮 Initializing Pong game...');
                
                // Create game instance
                game = await GameFramework.quickStart({
                    width: 800,
                    height: 400,
                    backgroundColor: '#0a0a0a',
                    debug: false,
                    canvasId: 'gameCanvas',
                    controls: {
                        // Player 1 controls (Karate Guy)
                        p1up: ['KeyW'],
                        p1down: ['KeyS'],
                        // Player 2 controls (Ninja Man)
                        p2up: ['ArrowUp'],
                        p2down: ['ArrowDown'],
                        // Game controls
                        start: ['Space'],
                        reset: ['KeyR']
                    }
                });

                await game.ready;
                console.log('✅ Game framework ready');

                // Create main scene
                const pongScene = new Scene('pong');
                
                pongScene.onLoad = async function() {
                    console.log('🏓 Loading Pong scene...');
                    
                    // Create players (paddles)
                    createPlayers();
                    
                    // Create ball
                    createBall();
                    
                    // Create UI
                    createUI();
                    
                    // Set up game events
                    setupGameEvents();
                    
                    console.log('🎯 Pong game loaded successfully!');
                };
                
                // Register and load scene
                game.registerScene('pong', pongScene);
                await game.loadScene('pong');
                
                // Start game loop
                game.start();
                
                console.log('🚀 Pong game started!');

            } catch (error) {
                console.error('💥 Failed to initialize game:', error);
                showError(error.message);
            }
        });

        // Global input handling for game controls
        document.addEventListener('keydown', (e) => {
            if (!game) return;
            
            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    if (!gameStarted) {
                        game.events.emit('game:start');
                    }
                    break;
                case 'KeyR':
                    if (!gameStarted) {
                        game.events.emit('game:reset');
                    }
                    break;
            }
        });

        // Create player paddles
        function createPlayers() {
            // Player 1 (Karate Guy) - Left side
            player1 = new BaseEntity({
                type: 'player',
                x: 30,
                y: game.canvas.height / 2 - 50,
                width: 15,
                height: 100
            });
            
            // Add custom paddle component
            player1.addComponent(new window.PaddleComponent({
                player: 1,
                speed: 400,
                color: '#ff6b6b',
                name: '🥋 Karate Guy'
            }));
            
            game.addEntity(player1);

            // Player 2 (Ninja Man) - Right side
            player2 = new BaseEntity({
                type: 'player',
                x: game.canvas.width - 45,
                y: game.canvas.height / 2 - 50,
                width: 15,
                height: 100
            });
            
            player2.addComponent(new window.PaddleComponent({
                player: 2,
                speed: 400,
                color: '#4ecdc4',
                name: '🥷 Ninja Man'
            }));
            
            game.addEntity(player2);
        }

        // Create ball
        function createBall() {
            ball = new BaseEntity({
                type: 'ball',
                x: game.canvas.width / 2 - 10,
                y: game.canvas.height / 2 - 10,
                width: 20,
                height: 20
            });
            
            ball.addComponent(new window.BallComponent({
                speed: ballSpeed,
                color: '#ffffff'
            }));
            
            game.addEntity(ball);
        }

        // Create UI elements
        function createUI() {
            // Score display
            const scoreDisplay = new window.ScoreDisplayComponent();
            const scoreEntity = new BaseEntity({
                type: 'ui',
                x: 0,
                y: 0,
                width: game.canvas.width,
                height: 50
            });
            scoreEntity.addComponent(scoreDisplay);
            game.addEntity(scoreEntity);

            // Center line
            const centerLine = new BaseEntity({
                type: 'decoration',
                x: game.canvas.width / 2 - 2,
                y: 0,
                width: 4,
                height: game.canvas.height
            });
            centerLine.addComponent(new window.CenterLineComponent());
            game.addEntity(centerLine);
        }

        // Set up game events
        function setupGameEvents() {
            // Ball scoring events
            game.events.on('ball:score', (data) => {
                score[`player${data.player}`]++;
                resetBall();
                
                // Check for win condition
                if (score.player1 >= 5 || score.player2 >= 5) {
                    gameStarted = false;
                    showWinner(data.player);
                }
            });

            // Game start/reset
            game.events.on('game:start', () => {
                if (!gameStarted) {
                    gameStarted = true;
                    resetBall();
                }
            });

            game.events.on('game:reset', () => {
                score.player1 = 0;
                score.player2 = 0;
                gameStarted = false;
                resetBall();
            });
        }

        // Reset ball to center
        function resetBall() {
            if (ball) {
                ball.x = game.canvas.width / 2 - 10;
                ball.y = game.canvas.height / 2 - 10;
                
                const ballComp = ball.getComponent(window.BallComponent);
                if (ballComp) {
                    ballComp.reset();
                }
            }
        }

        // Show winner
        function showWinner(player) {
            const winner = player === 1 ? '🥋 Karate Guy' : '🥷 Ninja Man';
            console.log(`🏆 ${winner} wins!`);
            
            // Create winner display
            setTimeout(() => {
                if (confirm(`🏆 ${winner} wins!\n\nFinal Score:\nKarate Guy: ${score.player1}\nNinja Man: ${score.player2}\n\nPlay again?`)) {
                    game.events.emit('game:reset');
                }
            }, 500);
        }

        // Show error
        function showError(message) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.innerHTML = `
                    <h1 style="color: #ff4444;">❌ Error</h1>
                    <div>${message}</div>
                    <div style="margin-top: 20px; font-size: 12px;">Check console for details</div>
                `;
                loading.style.display = 'block';
            }
        }

        // Handle loading errors
        window.addEventListener('gameframework:error', (e) => {
            showError('Failed to load GameFramework: ' + e.detail.error.message);
        });
    </script>
</body>
</html>